<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å‰åœ‹ä¸­ 204 é›»å­è¯çµ¡ç°¿</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        :root { --muji-bg: #f2f0eb; --muji-stone: #e0dbd1; --muji-charcoal: #333333; --muji-accent: #8c8c8c; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--muji-bg); color: var(--muji-charcoal); margin: 0; padding: 15px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); }
        
        /* æ¨™é¡Œæ”¾å¤§å€ */
        .header-area { text-align: center; margin-bottom: 40px; border-bottom: 2px solid var(--muji-charcoal); padding-bottom: 20px; }
        .school-info { font-size: 1.5em; color: var(--muji-accent); font-weight: 400; letter-spacing: 2px; margin-bottom: 10px; }
        .main-title { font-size: 3em; font-weight: 700; color: var(--muji-charcoal); margin: 0; letter-spacing: 5px; }
        
        .section { border-bottom: 1px solid var(--muji-stone); padding: 25px 0; }
        .homework-list { background: #fafafa; padding: 20px; border-radius: 4px; border-left: 5px solid var(--muji-accent); min-height: 80px; font-size: 1.2em; white-space: pre-wrap; line-height: 1.8; }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 1.1em; }
        select, textarea { width: 100%; padding: 15px; border: 1px solid var(--muji-stone); border-radius: 4px; box-sizing: border-box; font-size: 16px; font-family: inherit; }
        
        #admin-panel { display: none; background: #fdfdfd; padding: 20px; border: 2px solid var(--muji-stone); border-radius: 8px; margin-top: 20px; }
        #signature-pad { border: 1px solid var(--muji-stone); background: #fff; width: 100%; height: 350px; touch-action: none; border-radius: 4px; }
        
        .btn { background-color: var(--muji-charcoal); color: white; border: none; padding: 15px; cursor: pointer; width: 100%; font-size: 18px; border-radius: 4px; margin-top: 10px; }
        .btn-secondary { background-color: #8c8c8c; margin-top: 20px; }
        .btn-clear { background: none; border: 1px solid var(--muji-stone); color: var(--muji-accent); padding: 8px; margin-top: 10px; width: auto; font-size: 14px; }
        
        .sig-card { border: 1px solid var(--muji-stone); padding: 15px; margin-bottom: 15px; border-radius: 4px; background: white; }
        .sig-img { width: 100%; max-width: 400px; height: auto; border: 1px solid #eee; display: block; margin: 10px auto; }
        .unsigned-box { color: #d9534f; background: #fff1f0; padding: 15px; border-radius: 4px; border: 1px solid #ffa39e; margin-top: 10px; }

        /* æ‰‹æ©Ÿç‰ˆæ¨™é¡Œç¸®æ”¾èª¿æ•´ */
        @media (max-width: 600px) {
            .school-info { font-size: 1.2em; }
            .main-title { font-size: 2.2em; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-area">
        <div class="school-info">å¤§å‰åœ‹ä¸­ äºŒå¹´å››ç­</div>
        <h1 class="main-title">é›»å­è¯çµ¡ç°¿</h1>
    </div>

    <div class="section">
        <label>ğŸ“… ä»Šæ—¥æ—¥æœŸï¼š<span id="display-date"></span></label>
        <div id="homework-display" class="homework-list">è®€å–ä¸­...</div>
    </div>

    <div id="parent-area" class="section">
        <div class="input-group">
            <label>å­¸ç”Ÿåº§è™Ÿå§“å</label>
            <select id="student-select"><option value="">è«‹é¸æ“‡å­¸ç”Ÿ</option></select>
        </div>
        <div class="input-group">
            <label>æƒ³å°é‚±è€å¸«èªªçš„è©±</label>
            <textarea id="parent-comment" rows="2" placeholder="é¸å¡«"></textarea>
        </div>
        <div class="input-group">
            <label>å®¶é•·æ‰‹å¯«ç°½å (è«‹åœ¨ä¸‹æ–¹ç©ºç™½è™•ç°½å)</label>
            <canvas id="signature-pad"></canvas>
            <button class="btn-clear" onclick="signaturePad.clear()">æ¸…é™¤é‡ç°½</button>
        </div>
        <button class="btn" onclick="saveSignature()">å„²å­˜ä¸¦é€å‡º</button>
    </div>

    <button class="btn" style="background:none; color:var(--muji-accent); font-size:14px; border:1px solid var(--muji-stone); margin-top:50px;" onclick="adminAuth()">è€å¸«ç®¡ç†å…¥å£</button>

    <div id="admin-panel">
        <h2 style="border-bottom:2px solid var(--muji-stone); padding-bottom:10px;">é‚±è€å¸«ç®¡ç†å°</h2>
        
        <div class="input-group">
            <label>1. ç·¨è¼¯ä»Šæ—¥åŠŸèª² (è¼¸å…¥å¾ŒæŒ‰å„²å­˜)</label>
            <textarea id="hw-input" rows="8"></textarea>
            <button class="btn" onclick="saveHomework()">å„²å­˜ä»Šæ—¥åŠŸèª²</button>
        </div>

        <div class="section">
            <label>2. ç°½åçµ±è¨ˆèˆ‡å›è¦†æª¢è¦–</label>
            <button class="btn btn-secondary" onclick="loadStats()">è¼‰å…¥ä»Šæ—¥ç°½ååå–®</button>
            <div id="stats-output" style="margin-top:20px;"></div>
            <div id="sig-list" style="margin-top:20px;"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDDLO02aKJgvUa6Jk2GGslcWBhOtPHS4hE",
        authDomain: "homework-5072f.firebaseapp.com",
        projectId: "homework-5072f",
        storageBucket: "homework-5072f.firebasestorage.app",
        messagingSenderId: "927888465824",
        appId: "1:927888465824:web:7c6abc1c2212325900cec5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const today = new Date().toLocaleDateString('zh-TW').replace(/\//g, '-');
    document.getElementById('display-date').innerText = today;

    const students = ["ä½•ç¿ä¿¡","é™³æŸç¿°","é»ƒæ˜ç’¿","é»ƒå‰‡å–„","é»ƒæšç¿°","åŠ‰æ ¢ç¿","æ—èŠŠæƒ ","æ®µå­Ÿæ¶µ","æ´ªç…œæ™´","å¼µè‚²æ…ˆ","è¨±ä»¤éœ","å»–ä»¥æ™¨","åŠ‰æ™å¦¤"];

    const select = document.getElementById('student-select');
    students.forEach((name, i) => {
        let opt = document.createElement('option');
        opt.value = i + 1;
        opt.textContent = `${i + 1}. ${name}`;
        select.appendChild(opt);
    });

    const canvas = document.getElementById('signature-pad');
    window.signaturePad = new SignaturePad(canvas);

    onSnapshot(doc(db, "homework", today), (snap) => {
        const content = snap.exists() ? snap.data().content : "é‚±è€å¸«å°šæœªè¼¸å…¥ä»Šæ—¥åŠŸèª²ã€‚";
        document.getElementById('homework-display').innerText = content;
        document.getElementById('hw-input').value = snap.exists() ? content : "";
    });

    window.saveSignature = async () => {
        const sid = select.value;
        if (!sid || signaturePad.isEmpty()) return alert("è«‹å®Œæ•´å¡«å¯«åº§è™Ÿèˆ‡ç°½å");
        try {
            await addDoc(collection(db, "responses"), {
                date: today,
                studentId: parseInt(sid),
                studentName: students[sid-1],
                comment: document.getElementById('parent-comment').value,
                signature: signaturePad.toDataURL(),
                timestamp: new Date()
            });
            alert("ç°½åæˆåŠŸï¼");
            location.reload();
        } catch (e) { alert("å„²å­˜å¤±æ•—"); }
    };

    window.adminAuth = () => {
        if (prompt("ç®¡ç†å¯†ç¢¼ï¼š") === "0904") {
            document.getElementById('admin-panel').style.display = 'block';
            window.scrollTo(0, document.body.scrollHeight);
        } else { alert("å¯†ç¢¼éŒ¯èª¤"); }
    };

    window.saveHomework = async () => {
        const content = document.getElementById('hw-input').value;
        await setDoc(doc(db, "homework", today), { content });
        alert("åŠŸèª²å·²å„²å­˜ï¼");
    };

    window.loadStats = async () => {
        const statsOut = document.getElementById('stats-output');
        const sigList = document.getElementById('sig-list');
        statsOut.innerHTML = "è®€å–ä¸­...";
        sigList.innerHTML = "";

        try {
            const q = query(collection(db, "responses"), where("date", "==", today));
            const snap = await getDocs(q);
            let resData = [];
            snap.forEach(d => resData.push(d.data()));
            resData.sort((a, b) => a.studentId - b.studentId);

            let signedIds = [];
            let html = "";
            resData.forEach(r => {
                signedIds.push(r.studentId);
                html += `
                    <div class="sig-card">
                        <b>åº§è™Ÿ ${r.studentId} - ${r.studentName}</b><br>
                        <small>ç•™è¨€ï¼š${r.comment || 'ç„¡'}</small><br>
                        <img src="${r.signature}" class="sig-img">
                    </div>`;
            });

            const unsigned = students.map((_, i) => i + 1).filter(id => !signedIds.includes(id));
            statsOut.innerHTML = `
                <div style="font-size:1.2em;">å·²ç°½åï¼š<b>${signedIds.length}</b> / 13</div>
                <div class="unsigned-box">å°šæœªç°½åï¼š${unsigned.length === 0 ? 'å…¨æ•¸å®Œæˆ' : unsigned.join(', ')}</div>
            `;
            sigList.innerHTML = html;
        } catch (e) { statsOut.innerHTML = "è®€å–å¤±æ•—"; }
    };

    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        signaturePad.clear();
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();
</script>
</body>
</html>
