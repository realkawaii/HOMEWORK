<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大吉國中 204 電子聯絡簿</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, setDoc, onSnapshot, query, orderBy, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 請在此處替換成您的 Firebase 專案設定 ---
        const firebaseConfig = {
            apiKey: "您的API_KEY",
            authDomain: "您的專案.firebaseapp.com",
            projectId: "您的專案ID",
            storageBucket: "您的專案.appspot.com",
            messagingSenderId: "您的ID",
            appId: "您的APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 學生名單
        const students = [
            {id: 1, name: "何睿信"}, {id: 2, name: "陳柏翰"}, {id: 3, name: "黃明璿"},
            {id: 4, name: "黃則善"}, {id: 5, name: "黃暐翰"}, {id: 6, name: "劉栢睿"},
            {id: 7, name: "林芊惠"}, {id: 8, name: "段孟涵"}, {id: 9, name: "洪煜晴"},
            {id: 10, name: "張育慈"}, {id: 11, name: "許令霏"}, {id: 12, name: "廖以晨"},
            {id: 13, name: "劉晏妤"}
        ];

        // 全域變數供按鈕調用
        window.saveHomework = async () => {
            const content = document.getElementById('hw-input').value;
            if (!content) return alert("請輸入功課內容");
            const today = new Date().toISOString().split('T')[0];
            await setDoc(doc(db, "homework", today), {
                content: content,
                timestamp: serverTimestamp()
            });
            alert("功課發布成功！");
        };

        window.submitSignature = async () => {
            const id = document.getElementById('student-select').value;
            const comment = document.getElementById('parent-comment').value;
            if (!id || signaturePad.isEmpty()) return alert("請選擇學生並簽名");

            const now = new Date();
            const timeStr = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;

            await addDoc(collection(db, "responses"), {
                studentId: parseInt(id),
                comment: comment,
                signature: signaturePad.toDataURL(),
                submitTime: timeStr,
                createdAt: serverTimestamp(),
                dateLabel: now.toISOString().split('T')[0]
            });
            alert("簽名已儲存！");
            signaturePad.clear();
            document.getElementById('parent-comment').value = "";
        };

        window.deleteRecord = async (docId) => {
            if (confirm("確定要刪除這筆紀錄嗎？")) {
                await deleteDoc(doc(db, "responses", docId));
            }
        };

        // 即時監聽數據
        const todayStr = new Date().toISOString().split('T')[0];
        
        // 監聽今日功課
        onSnapshot(doc(db, "homework", todayStr), (doc) => {
            document.getElementById('hw-display').innerText = doc.exists() ? doc.data().content : "今日暫無功課內容";
        });

        // 監聽簽到紀錄
        const q = query(collection(db, "responses"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            const listDiv = document.getElementById('admin-list');
            const signedIds = [];
            let html = "";
            
            snapshot.forEach((doc) => {
                const data = doc.data();
                if (data.dateLabel === todayStr) {
                    signedIds.push(data.studentId);
                    const student = students.find(s => s.id === data.studentId);
                    html += `
                        <div class="record-card">
                            <b>${student ? student.name : '未知'} (${data.studentId}號)</b> - ${data.submitTime}
                            <p>留言：${data.comment || '無'}</p>
                            <img src="${data.signature}" width="120">
                            <button onclick="deleteRecord('${doc.id}')" style="color:red;border:none;background:none;cursor:pointer;">[刪除]</button>
                        </div>`;
                }
            });
            listDiv.innerHTML = html;
            
            // 統計
            const unsigned = students.filter(s => !signedIds.includes(s.id));
            document.getElementById('stats').innerHTML = `
                已簽名：${signedIds.length} / 13 <br>
                <span style="color:red">未簽名座號：${unsigned.map(s => s.id).join(', ')}</span>
            `;
        });

        // 初始化選單
        const select = document.getElementById('student-select');
        students.forEach(s => {
            select.innerHTML += `<option value="${s.id}">${s.id}. ${s.name}</option>`;
        });
    </script>

    <style>
        :root { --muji-bg: #f4f1ea; --muji-text: #333; --muji-grey: #8c8c8c; }
        body { font-family: 'Noto Sans TC', sans-serif; background: var(--muji-bg); color: var(--muji-text); padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); max-width: 500px; margin: 0 auto 20px; }
        h2 { border-bottom: 1px solid #ddd; padding-bottom: 10px; font-size: 1.2em; }
        textarea, select, input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; box-sizing: border-box; }
        .btn { background: var(--muji-text); color: white; border: none; padding: 12px; width: 100%; cursor: pointer; border-radius: 2px; }
        #signature-pad { border: 1px solid #eee; background: #fafafa; width: 100%; height: 150px; }
        .record-card { border-left: 3px solid var(--muji-grey); padding-left: 10px; margin-bottom: 15px; font-size: 0.9em; background: #f9f9f9; padding: 10px; }
        .admin-only { display: none; background: #efefef; }
    </style>
</head>
<body>

<div class="card">
    <div style="text-align:center; color:var(--muji-grey); font-size:0.8em;">大吉國中 二年四班</div>
    <h1 style="text-align:center; font-size:1.5em;">電子聯絡簿</h1>
    
    <h2>今日功課</h2>
    <div id="hw-display" style="white-space: pre-wrap; padding:10px; background:#fdfdfd;">載入中...</div>
</div>

<div class="card">
    <h2>家長簽署區</h2>
    <select id="student-select"><option value="">請選擇學生座號</option></select>
    <textarea id="parent-comment" placeholder="想跟老師說的話 (選填)"></textarea>
    <canvas id="signature-pad"></canvas>
    <button onclick="signaturePad.clear()" style="font-size:10px;">清除重簽</button>
    <button class="btn" onclick="submitSignature()" style="margin-top:10px;">確認儲存</button>
</div>

<div class="card">
    <button onclick="checkAdmin()" style="background:none; border:none; color:grey; font-size:12px; cursor:pointer;">教師管理登入</button>
    <div id="admin-zone" class="admin-only">
        <h2>發布功課</h2>
        <textarea id="hw-input" placeholder="輸入今日功課..."></textarea>
        <button class="btn" onclick="saveHomework()">更新功課</button>
        
        <h2 style="margin-top:20px;">簽署進度</h2>
        <div id="stats" style="margin-bottom:15px;"></div>
        <div id="admin-list"></div>
    </div>
</div>

<script>
    const canvas = document.getElementById('signature-pad');
    const signaturePad = new SignaturePad(canvas);
    
    function checkAdmin() {
        const pass = prompt("請輸入老師管理密碼：");
        if (pass === "0904") {
            document.getElementById('admin-zone').style.display = 'block';
        } else {
            alert("密碼錯誤");
        }
    }
</script>

</body>
</html>
