<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å‰åœ‹ä¸­ 204 é›»å­è¯çµ¡ç°¿</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        :root { --muji-bg: #f2f0eb; --muji-stone: #e0dbd1; --muji-charcoal: #333333; --muji-accent: #8c8c8c; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--muji-bg); color: var(--muji-charcoal); margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 25px; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .school-info { font-size: 0.9em; color: var(--muji-accent); text-align: center; margin-bottom: 5px; }
        h1 { text-align: center; font-weight: 500; margin-top: 0; }
        .section { border-bottom: 1px solid var(--muji-stone); padding: 20px 0; }
        .homework-list { background: #fafafa; padding: 15px; border-radius: 4px; border-left: 4px solid var(--muji-accent); min-height: 50px; white-space: pre-wrap; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--muji-stone); border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        #signature-pad { border: 1px solid var(--muji-stone); background: #fff; width: 100%; height: 200px; touch-action: none; border-radius: 4px; }
        .btn { background-color: var(--muji-charcoal); color: white; border: none; padding: 12px; cursor: pointer; width: 100%; font-size: 16px; border-radius: 4px; margin-top: 10px; }
        .btn-admin { background-color: var(--muji-bg); color: var(--muji-accent); border: 1px solid var(--muji-stone); margin-top: 40px; }
        .status-tag { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; background: #eee; margin-left: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="school-info">å¤§å‰åœ‹ä¸­ äºŒå¹´å››ç­</div>
    <h1>é›»å­è¯çµ¡ç°¿</h1>

    <div class="section">
        <label>ğŸ“… ä»Šæ—¥æ—¥æœŸï¼š<span id="display-date"></span></label>
        <div id="homework-display" class="homework-list">è®€å–ä»Šæ—¥åŠŸèª²ä¸­...</div>
    </div>

    <div id="parent-area" class="section">
        <div class="input-group">
            <label>1. é¸æ“‡å­¸ç”Ÿåº§è™Ÿå§“å</label>
            <select id="student-select">
                <option value="">è«‹é¸æ“‡...</option>
            </select>
        </div>
        <div class="input-group">
            <label>2. æƒ³è·Ÿé‚±è€å¸«èªªçš„è©± (é¸å¡«)</label>
            <textarea id="parent-comment" rows="2"></textarea>
        </div>
        <div class="input-group">
            <label>3. å®¶é•·æ‰‹å¯«ç°½å</label>
            <canvas id="signature-pad"></canvas>
            <button onclick="signaturePad.clear()" style="background:none; border:none; color:var(--muji-accent); cursor:pointer; font-size:12px; padding:5px;">æ¸…é™¤é‡ç°½</button>
        </div>
        <button class="btn" onclick="saveSignature()">å„²å­˜ä¸¦é€å‡ºç°½å</button>
    </div>

    <button class="btn btn-admin" onclick="adminLogin()">è€å¸«ç®¡ç†å…¥å£</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDDLO02aKJgvUa6Jk2GGslcWBhOtPHS4hE",
        authDomain: "homework-5072f.firebaseapp.com",
        projectId: "homework-5072f",
        storageBucket: "homework-5072f.firebasestorage.app",
        messagingSenderId: "927888465824",
        appId: "1:927888465824:web:7c6abc1c2212325900cec5",
        measurementId: "G-N9G0HZM1NT"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const today = new Date().toLocaleDateString('zh-TW').replace(/\//g, '-');
    document.getElementById('display-date').innerText = today;

    const students = [
        "ä½•ç¿ä¿¡","é™³æŸç¿°","é»ƒæ˜ç’¿","é»ƒå‰‡å–„","é»ƒæšç¿°","åŠ‰æ ¢ç¿","æ—èŠŠæƒ ","æ®µå­Ÿæ¶µ","æ´ªç…œæ™´","å¼µè‚²æ…ˆ","è¨±ä»¤éœ","å»–ä»¥æ™¨","åŠ‰æ™å¦¤"
    ];

    // åˆå§‹åŒ–ä¸‹æ‹‰é¸å–®
    const select = document.getElementById('student-select');
    students.forEach((name, index) => {
        let opt = document.createElement('option');
        opt.value = index + 1;
        opt.textContent = `${index + 1}. ${name}`;
        select.appendChild(opt);
    });

    // åˆå§‹åŒ–ç°½åæ¿
    const canvas = document.getElementById('signature-pad');
    window.signaturePad = new SignaturePad(canvas);

    // ç›£è½ä»Šæ—¥åŠŸèª² (å³æ™‚æ›´æ–°)
    onSnapshot(doc(db, "homework", today), (doc) => {
        document.getElementById('homework-display').innerText = doc.exists() ? doc.data().content : "é‚±è€å¸«å°šæœªè¼¸å…¥ä»Šæ—¥åŠŸèª²";
    });

    // å®¶é•·å„²å­˜ç°½å
    window.saveSignature = async () => {
        const sid = select.value;
        if (!sid || signaturePad.isEmpty()) return alert("è«‹é¸æ“‡å­¸ç”Ÿä¸¦å®Œæˆç°½å");
        
        try {
            await addDoc(collection(db, "responses"), {
                date: today,
                studentId: parseInt(sid),
                studentName: students[sid-1],
                comment: document.getElementById('parent-comment').value,
                signature: signaturePad.toDataURL(),
                timestamp: new Date()
            });
            alert("ç°½åå·²å„²å­˜ï¼Œè¬è¬å®¶é•·ï¼");
            location.reload();
        } catch (e) { alert("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯"); }
    };

    // è€å¸«ç®¡ç†åŠŸèƒ½
    window.adminLogin = async () => {
        const pw = prompt("è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ï¼š");
        if (pw !== "0904") return alert("å¯†ç¢¼éŒ¯èª¤");

        const mode = prompt("è«‹é¸æ“‡åŠŸèƒ½ï¼š\n1. è¼¸å…¥ä»Šæ—¥åŠŸèª²\n2. æŸ¥çœ‹ç°½åèˆ‡çµ±è¨ˆ");
        
        if (mode === "1") {
            const content = prompt("è«‹è¼¸å…¥ä»Šæ—¥åŠŸèª²å…§å®¹ï¼š");
            if (content) await setDoc(doc(db, "homework", today), { content });
        } else if (mode === "2") {
            const q = query(collection(db, "responses"), where("date", "==", today));
            const snap = await getDocs(q);
            let signedIds = [];
            let detailStr = `--- ä»Šæ—¥ç°½åè©³æƒ… ---\n`;
            
            snap.forEach(d => {
                const data = d.data();
                signedIds.push(data.studentId);
                detailStr += `åº§è™Ÿ ${data.studentId}ï¼š${data.comment || 'ç„¡ç•™è¨€'}\n`;
            });

            const unsigned = students.map((n, i) => i + 1).filter(id => !signedIds.includes(id));
            alert(`${detailStr}\nçµ±è¨ˆï¼š${signedIds.length} ä½å·²ç°½å\næœªç°½ååº§è™Ÿï¼š${unsigned.join(', ') || 'å…¨æ•¸å®Œæˆ'}`);
        }
    };
</script>
</body>
</html>