<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å‰åœ‹ä¸­ 204 é›»å­è¯çµ¡ç°¿</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, setDoc, getDocs, onSnapshot, query, orderBy, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDDLO02aKJgvUa6Jk2GGslcWBhOtPHS4hE",
            authDomain: "homework-5072f.firebaseapp.com",
            projectId: "homework-5072f",
            storageBucket: "homework-5072f.firebasestorage.app",
            messagingSenderId: "927888465824",
            appId: "1:927888465824:web:7c6abc1c2212325900cec5",
            measurementId: "G-N9G0HZM1NT"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const students = [
            {id: 1, name: "ä½•ç¿ä¿¡"}, {id: 2, name: "é™³æŸç¿°"}, {id: 3, name: "é»ƒæ˜ç’¿"},
            {id: 4, name: "é»ƒå‰‡å–„"}, {id: 5, name: "é»ƒæšç¿°"}, {id: 6, name: "åŠ‰æ ¢ç¿"},
            {id: 7, name: "æ—èŠŠæƒ "}, {id: 8, name: "æ®µå­Ÿæ¶µ"}, {id: 9, name: "æ´ªç…œæ™´"},
            {id: 10, name: "å¼µè‚²æ…ˆ"}, {id: 11, name: "è¨±ä»¤éœ"}, {id: 12, name: "å»–ä»¥æ™¨"},
            {id: 13, name: "åŠ‰æ™å¦¤"}
        ];

        const todayKey = new Date().toLocaleDateString('en-CA');

        // æ›´æ–°ä»Šæ—¥æ—¥æœŸé¡¯ç¤º
        document.getElementById('current-date').innerText = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });

        // è€å¸«ç«¯ï¼šç™¼å¸ƒåŠŸèª² (æœƒä¾æ—¥æœŸå„²å­˜)
        window.saveHomework = async () => {
            const content = document.getElementById('hw-input').value;
            if (!content) return alert("è«‹è¼¸å…¥åŠŸèª²å…§å®¹");
            await setDoc(doc(db, "homework", todayKey), {
                content: content,
                date: todayKey,
                timestamp: serverTimestamp()
            });
            alert("ä»Šæ—¥åŠŸèª²å·²æ›´æ–°ï¼");
        };

        // æ­·å²åŠŸèª²æŸ¥è©¢
        window.toggleHistory = async () => {
            const historyDiv = document.getElementById('history-section');
            if (historyDiv.style.display === 'none') {
                const q = query(collection(db, "homework"), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                let html = "<h3>æ­·å²åŠŸèª²ç´€éŒ„</h3>";
                querySnapshot.forEach((doc) => {
                    if(doc.id !== todayKey) {
                        html += `<div class='history-item'><b>${doc.id}</b><br>${doc.data().content}</div>`;
                    }
                });
                document.getElementById('history-list').innerHTML = html || "æš«ç„¡éå»ç´€éŒ„";
                historyDiv.style.display = 'block';
            } else {
                historyDiv.style.display = 'none';
            }
        };

        // å®¶é•·ç«¯ï¼šæäº¤ç°½å
        window.submitSignature = async () => {
            const id = document.getElementById('student-select').value;
            const comment = document.getElementById('parent-comment').value;
            if (!id || signaturePad.isEmpty()) return alert("è«‹é¸æ“‡å­¸ç”Ÿä¸¦ç°½å");

            const now = new Date();
            const timeStr = now.toLocaleString('zh-TW', { hour12: false }); 

            try {
                await addDoc(collection(db, "responses"), {
                    studentId: parseInt(id),
                    comment: comment,
                    signature: signaturePad.toDataURL(),
                    submitTime: timeStr,
                    createdAt: serverTimestamp(),
                    dateLabel: todayKey
                });
                alert("å„²å­˜æˆåŠŸ"); 
                signaturePad.clear();
                document.getElementById('parent-comment').value = "";
            } catch (e) { alert("å„²å­˜å¤±æ•—"); }
        };

        window.deleteRecord = async (docId) => {
            if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) await deleteDoc(doc(db, "responses", docId));
        };

        // ç›£è½ä»Šæ—¥åŠŸèª²
        onSnapshot(doc(db, "homework", todayKey), (doc) => {
            document.getElementById('hw-display').innerText = doc.exists() ? doc.data().content : "å°šæœªç™¼å¸ƒä»Šæ—¥åŠŸèª²";
        });

        // ç›£è½ç®¡ç†å“¡åˆ—è¡¨
        const q = query(collection(db, "responses"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            const listDiv = document.getElementById('admin-list');
            const signedIds = [];
            let html = "";
            snapshot.forEach((doc) => {
                const data = doc.data();
                if (data.dateLabel === todayKey) {
                    signedIds.push(data.studentId);
                    const student = students.find(s => s.id === data.studentId);
                    html += `<div class="record-card">
                        <b>${data.studentId}è™Ÿ ${student?.name}</b> <small>${data.submitTime}</small>
                        <p>ç•™è¨€ï¼š${data.comment || 'ç„¡'}</p>
                        <img src="${data.signature}" width="100">
                        <button onclick="deleteRecord('${doc.id}')" style="color:red;border:none;background:none;cursor:pointer;">[åˆªé™¤]</button>
                    </div>`;
                }
            });
            listDiv.innerHTML = html;
            const unsigned = students.filter(s => !signedIds.includes(s.id));
            document.getElementById('stats').innerHTML = `<b>ç°½æ”¶ï¼š${signedIds.length}/13</b> | <span style="color:red">æœªç°½ï¼š${unsigned.map(s => s.id).join(', ')}</span>`;
        });

        const select = document.getElementById('student-select');
        students.forEach(s => { select.innerHTML += `<option value="${s.id}">${s.id}. ${s.name}</option>`; });
    </script>

    <style>
        :root { --muji-bg: #f2f0eb; --muji-text: #333; }
        body { font-family: 'Noto Sans TC', sans-serif; background: var(--muji-bg); color: var(--muji-text); padding: 15px; margin: 0; }
        .container { max-width: 600px; margin: 0 auto; }
        .card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* æ”¾å¤§å­—é«”éƒ¨åˆ† */
        .school-title { font-size: 1.2em; color: #888; text-align: center; margin-bottom: 5px; }
        .main-title { font-size: 2.4em; text-align: center; margin: 0 0 15px; font-weight: 700; letter-spacing: 2px; }
        #current-date { font-size: 1.1em; color: #555; margin-bottom: 5px; display: block; }
        .section-title { font-size: 1.6em; font-weight: 700; border-left: 6px solid #8c8c8c; padding-left: 15px; margin: 10px 0; }
        #hw-display { font-size: 1.5em; line-height: 1.5; white-space: pre-wrap; background: #fdfdfd; padding: 20px; border: 1px solid #eee; border-radius: 5px; color: #000; font-weight: 500; }
        
        textarea, select { width: 100%; padding: 15px; border: 1px solid #ccc; border-radius: 5px; font-size: 18px; margin-top: 10px; }
        .btn { background: #333; color: white; border: none; padding: 18px; width: 100%; cursor: pointer; margin-top: 15px; font-size: 1.2em; border-radius: 5px; font-weight: 700; }
        .btn-history { background: #8c8c8c; margin-top: 10px; padding: 10px; font-size: 1em; }
        #signature-pad { border: 1px solid #ddd; background: #fff; width: 100%; height: 200px; margin-top: 10px; }
        .history-item { border-bottom: 1px dashed #ccc; padding: 10px 0; font-size: 0.9em; }
        .record-card { background: #f9f9f9; border: 1px solid #eee; padding: 15px; margin-bottom: 10px; border-radius: 5px; }
        .admin-only { display: none; margin-top: 30px; border-top: 2px solid #ccc; padding-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <div class="school-title">å¤§å‰åœ‹ä¸­ äºŒå¹´å››ç­</div>
        <h1 class="main-title">é›»å­è¯çµ¡ç°¿</h1>
        
        <span id="current-date"></span>
        <div class="section-title">ä»Šæ—¥åŠŸèª²å…§å®¹</div>
        <div id="hw-display">è®€å–ä¸­...</div>
        
        <button class="btn btn-history" onclick="toggleHistory()">ğŸ“… æŸ¥çœ‹æ­·å²åŠŸèª²</button>
        <div id="history-section" style="display:none; margin-top:15px; background:#f5f5f5; padding:15px; border-radius:5px;">
            <div id="history-list"></div>
        </div>
    </div>

    <div class="card">
        <div class="section-title">å®¶é•·ç°½ç½²</div>
        <select id="student-select"><option value="">-- è«‹é¸æ“‡å­¸ç”Ÿåº§è™Ÿ --</option></select>
        <textarea id="parent-comment" rows="2" placeholder="æƒ³è·Ÿè€å¸«èªªçš„è©± (é¸å¡«)"></textarea>
        <canvas id="signature-pad"></canvas>
        <button onclick="signaturePad.clear()" style="background:none; border:none; color:#999; text-decoration:underline; cursor:pointer;">æ¸…é™¤é‡ç°½</button>
        <button class="btn" onclick="submitSignature()">ç¢ºèªå„²å­˜ç°½å</button>
    </div>

    <div style="text-align:center; padding-bottom:50px;">
        <button onclick="checkAdmin()" style="background:none; border:none; color:#ccc; cursor:pointer;">æ•™å¸«ç®¡ç†</button>
        <div id="admin-zone" class="admin-only">
            <h2 class="section-title">ç™¼å¸ƒæ–°åŠŸèª²</h2>
            <textarea id="hw-input" rows="4" placeholder="åœ¨æ­¤è¼¸å…¥ä»Šæ—¥åŠŸèª²å…§å®¹..."></textarea>
            <button class="btn" onclick="saveHomework()">å„²å­˜ä»Šæ—¥åŠŸèª²</button>
            
            <h2 class="section-title">ä»Šæ—¥çµ±è¨ˆ</h2>
            <div id="stats" style="margin-bottom:20px; font-size:1.2em;"></div>
            <div id="admin-list"></div>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('signature-pad');
    const signaturePad = new SignaturePad(canvas);
    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        signaturePad.clear();
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    function checkAdmin() {
        if (prompt("ç®¡ç†å¯†ç¢¼ï¼š") === "0904") {
            document.getElementById('admin-zone').style.display = 'block';
            document.getElementById('admin-zone').scrollIntoView({behavior: 'smooth'});
        } else { alert("éŒ¯èª¤"); }
    }
</script>
</body>
</html>
