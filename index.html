<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å‰åœ‹ä¸­ 204 é›»å­è¯çµ¡ç°¿</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDDLO02aKJgvUa6Jk2GGslcWBhOtPHS4hE",
            authDomain: "homework-5072f.firebaseapp.com",
            projectId: "homework-5072f",
            storageBucket: "homework-5072f.firebasestorage.app",
            messagingSenderId: "927888465824",
            appId: "1:927888465824:web:7c6abc1c2212325900cec5",
            measurementId: "G-N9G0HZM1NT"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const students = [{id:1, name:"ä½•ç¿ä¿¡"}, {id:2, name:"é™³æŸç¿°"}, {id:3, name:"é»ƒæ˜ç’¿"}, {id:4, name:"é»ƒå‰‡å–„"}, {id:5, name:"é»ƒæšç¿°"}, {id:6, name:"åŠ‰æ ¢ç¿"}, {id:7, name:"æ—èŠŠæƒ "}, {id:8, name:"æ®µå­Ÿæ¶µ"}, {id:9, name:"æ´ªç…œæ™´"}, {id:10, name:"å¼µè‚²æ…ˆ"}, {id:11, name:"è¨±ä»¤éœ"}, {id:12, name:"å»–ä»¥æ™¨"}, {id:13, name:"åŠ‰æ™å¦¤"}];
        
        const sel = document.getElementById('student-sel');
        students.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.id;
            opt.textContent = `${s.id}. ${s.name}`;
            sel.appendChild(opt);
        });

        const canvas = document.getElementById('canvas');
        const pad = new SignaturePad(canvas);

        function getFormattedDate() {
            const now = new Date();
            const days = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
            return `${now.toLocaleDateString('zh-TW')} ${days[now.getDay()]}`;
        }

        // ç›£è½ä»Šæ—¥åŠŸèª²
        onSnapshot(doc(db, "configs", "today_homework"), (docSnap) => {
            if (docSnap.exists()) {
                document.getElementById('hw-content').innerText = docSnap.data().content;
                document.getElementById('hw-date').innerText = docSnap.data().date || getFormattedDate();
            }
        });

        // æ›´æ–°åŠŸèª² (è€å¸«èˆ‡å­¸ç”Ÿå…±ç”¨)
        window.updateHW = async () => {
            const val = document.getElementById('hw-input').value;
            if(!val) return alert("è«‹è¼¸å…¥å…§å®¹");
            const oldContent = document.getElementById('hw-content').innerText;
            const oldDate = document.getElementById('hw-date').innerText;

            try {
                await addDoc(collection(db, "history_homework"), {
                    date: oldDate,
                    content: oldContent,
                    timestamp: Date.now()
                });
                await setDoc(doc(db, "configs", "today_homework"), {
                    content: val,
                    date: getFormattedDate()
                });
                document.getElementById('hw-input').value = '';
                alert("é»‘æ¿å·²æˆåŠŸæ›´æ–°ï¼");
            } catch(e) { alert("ç™¼å¸ƒå¤±æ•—ï¼š" + e); }
        };

        // å®¶é•·ç°½åå„²å­˜
        window.saveData = async () => {
            const sid = sel.value;
            if(!sid || pad.isEmpty()) return alert("è«‹é¸å–åº§è™Ÿä¸¦ç°½å");
            try {
                await addDoc(collection(db, "signatures"), {
                    sid: sid,
                    name: students.find(s => s.id == sid).name,
                    comment: document.getElementById('comment').value,
                    sig: pad.toDataURL(),
                    time: new Date().toLocaleTimeString(),
                    timestamp: Date.now()
                });
                alert("ç°½åå„²å­˜æˆåŠŸï¼");
                pad.clear();
            } catch(e) { alert("å„²å­˜å¤±æ•—"); }
        };

        // æŸ¥çœ‹ä¹‹å‰åŠŸèª² (æ‘ºç–ŠåŠŸèƒ½)
        let isHistoryShow = false;
        window.toggleHistory = () => {
            const box = document.getElementById('history-box');
            isHistoryShow = !isHistoryShow;
            if (isHistoryShow) {
                const q = query(collection(db, "history_homework"), orderBy("timestamp", "desc"));
                onSnapshot(q, (snapshot) => {
                    box.innerHTML = snapshot.docs.map(d => `<div class="hist-item"><b>${d.data().date}</b><br>${d.data().content}</div>`).join('');
                });
                box.style.display = 'block';
            } else {
                box.style.display = 'none';
            }
        };

        // --- ç™»å…¥é‚è¼¯åˆ†æµ ---
        window.loginAdmin = () => {
            const pw = prompt("è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼ï¼š");
            const adminPanel = document.getElementById('admin-panel');
            const teacherExtra = document.getElementById('teacher-extra');

            if (pw === "0904") {
                // è€å¸«æ¬Šé™ï¼šé¡¯ç¤ºå…¨éƒ¨
                adminPanel.style.display = 'block';
                teacherExtra.style.display = 'block';
                initAdminListeners();
            } else if (pw === "0214") {
                // å­¸ç”Ÿæ¬Šé™ï¼šåªé¡¯ç¤ºç™¼å¸ƒåŠŸèª²ï¼Œéš±è—å…¶é¤˜
                adminPanel.style.display = 'block';
                teacherExtra.style.display = 'none';
                alert("å­¸ç”Ÿæ¬Šé™å·²ç™»å…¥ï¼šåƒ…é–‹æ”¾ç™¼å¸ƒåŠŸèª²åŠŸèƒ½ã€‚");
            } else {
                alert("å¯†ç¢¼éŒ¯èª¤ï¼");
            }
        };

        function initAdminListeners() {
            // ç›£è½æ­·å²åŠŸèª²ç®¡ç†
            onSnapshot(query(collection(db, "history_homework"), orderBy("timestamp", "desc")), (snap) => {
                document.getElementById('admin-history-manage').innerHTML = snap.docs.map(d => `
                    <div class="edit-card">
                        <small>${d.data().date}</small>
                        <textarea id="edit-${d.id}" style="width:100%; margin:5px 0;">${d.data().content}</textarea>
                        <button onclick="window.saveEditHW('${d.id}')">å„²å­˜ä¿®æ”¹</button>
                        <button onclick="window.deleteHW('${d.id}')" style="color:red;">åˆªé™¤</button>
                    </div>
                `).join('');
            });
            // ç›£è½ç°½å
            onSnapshot(query(collection(db, "signatures"), orderBy("timestamp", "desc")), (snap) => {
                const records = snap.docs.map(d => d.data());
                const signedIds = records.map(r => parseInt(r.sid));
                const unsigned = students.filter(s => !signedIds.includes(s.id));
                document.getElementById('stats-area').innerHTML = `<div style="background:#fff1f1; padding:10px; border-radius:4px;">æœªç°½åï¼š${unsigned.length > 0 ? unsigned.map(s => s.name).join('ã€') : 'å…¨ç­å·²å®Œæˆ'}</div>`;
                
                document.getElementById('records-list').innerHTML = snap.docs.map(d => `
                    <div class="record-card">
                        <b>${d.data().sid}. ${d.data().name} (${d.data().time})</b><br>
                        ç•™è¨€ï¼š${d.data().comment || 'ç„¡'}<br>
                        <img src="${d.data().sig}" style="width:100%; border:1px solid #eee; background:#fff;">
                        <button onclick="window.deleteSig('${d.id}')" style="color:red; background:none; border:none; cursor:pointer;">[åˆªé™¤ç´€éŒ„]</button>
                    </div>
                `).join('');
            });
        }

        window.saveEditHW = async (id) => {
            const newContent = document.getElementById(`edit-${id}`).value;
            await updateDoc(doc(db, "history_homework", id), { content: newContent });
            alert("æ­·å²å…§å®¹å·²ä¿®æ­£");
        };
        window.deleteHW = async (id) => {
            if(confirm("ç¢ºå®šåˆªé™¤æ­·å²ç´€éŒ„ï¼Ÿ")) await deleteDoc(doc(db, "history_homework", id));
        };
        window.deleteSig = async (id) => {
            if(confirm("ç¢ºå®šåˆªé™¤ç°½åï¼Ÿ")) await deleteDoc(doc(db, "signatures", id));
        };

        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            pad.clear();
        }
        window.onresize = resizeCanvas;
        resizeCanvas();
    </script>

    <style>
        :root { --muji-bg: #f2f0eb; --blackboard-green: #2c4c3e; --chalk-white: #fdfdfd; --muji-charcoal: #333333; }
        * { box-sizing: border-box; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--muji-bg); color: var(--muji-charcoal); margin: 0; padding: 15px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header-section { text-align: center; margin-bottom: 25px; }
        .school-info, .main-title { font-size: 2em; font-weight: 700; display: block; line-height: 1.4; }
        .blackboard { background-color: var(--blackboard-green); border: 12px solid #5d4037; border-radius: 4px; padding: 20px; text-align: center; }
        .bb-title { color: #ffd54f; font-size: 1.8em; font-weight: 700; margin-bottom: 5px; }
        .bb-date { color: rgba(255,255,255,0.8); font-size: 1.1em; margin-bottom: 15px; border-bottom: 1px dashed rgba(255,255,255,0.3); padding-bottom: 10px; }
        .homework-content { color: var(--chalk-white); font-size: 1.4em; line-height: 1.8; white-space: pre-wrap; min-height: 100px; text-align: left; }
        .btn { background-color: var(--muji-charcoal); color: white; border: none; padding: 18px; cursor: pointer; width: 100%; font-size: 20px; border-radius: 6px; font-weight: 700; }
        .btn-history { background: none; border: 2px solid #888; color: #888; font-size: 16px; margin-top: 5px; height: 50px; }
        #history-box { display: none; padding: 15px; background: #f0f0f0; margin-top: 10px; border-radius: 4px; border: 1px solid #ddd; }
        .hist-item { border-bottom: 1px solid #ccc; padding: 10px 0; }
        .admin-area { display: none; margin-top: 40px; padding: 20px; background: #eef2f3; border-radius: 8px; border: 2px solid #ccc; }
        .record-card, .edit-card { background: white; border: 1px solid #bbb; padding: 15px; margin-bottom: 10px; border-radius: 4px; }
        .sig-wrapper { border: 2px solid var(--muji-charcoal); background: #fff; border-radius: 6px; }
        canvas { width: 100%; height: 350px; touch-action: none; display: block; }
    </style>
</head>
<body>
<div class="container">
    <div class="header-section">
        <span class="school-info">å¤§å‰åœ‹ä¸­ äºŒå¹´å››ç­</span>
        <span class="main-title">é›»å­è¯çµ¡ç°¿</span>
    </div>
    <div class="blackboard">
        <div class="bb-title">ä»Šæ—¥åŠŸèª²</div>
        <div class="bb-date" id="hw-date">è¼‰å…¥ä¸­...</div>
        <div id="hw-content" class="homework-content">è¼‰å…¥ä¸­...</div>
    </div>
    <button class="btn btn-history" onclick="toggleHistory()">ğŸ“‚ æŸ¥çœ‹ä¹‹å‰åŠŸèª² (å±•é–‹/æ”¶èµ·)</button>
    <div id="history-box"></div>
    <div style="font-size: 1.3em; font-weight: 700; border-left: 6px solid #333; padding-left: 12px; margin: 25px 0 15px 0;">å®¶é•·ç°½å</div>
    <div style="margin-bottom:20px;"><label style="font-weight:700;">1. é¸æ“‡å­¸ç”Ÿ</label><select id="student-sel" style="width:100%; padding:14px; font-size:18px;"><option value="">è«‹é»æ“Šé¸æ“‡åº§è™Ÿå§“å</option></select></div>
    <div style="margin-bottom:20px;"><label style="font-weight:700;">2. æƒ³å°è€å¸«èªªçš„è©±</label><textarea id="comment" rows="2" style="width:100%; padding:14px; font-size:18px;"></textarea></div>
    <div style="margin-bottom:20px;"><label style="font-weight:700;">3. å®¶é•·ç°½å</label><div class="sig-wrapper"><canvas id="canvas"></canvas></div><button onclick="pad.clear()" style="width:100%; padding:10px; background:none; border:none; text-decoration:underline; color:#666; cursor:pointer;">æ¸…é™¤é‡ç°½</button></div>
    <button class="btn" onclick="saveData()">ç¢ºèªå„²å­˜ä¸¦é€å‡º</button>

    <button onclick="loginAdmin()" style="margin-top:100px; opacity:0.1; background:none; border:none; width:100%;">ç®¡ç†</button>
    <div id="admin-panel" class="admin-area">
        <h3>ç®¡ç†å¾Œå°</h3>
        <div style="margin-bottom:20px;">
            <label>ç™¼å¸ƒæ–°åŠŸèª² (è¼¸å…¥å¾Œé»‘æ¿å³æ›´æ–°)</label>
            <textarea id="hw-input" rows="3" style="width:100%; padding:10px;"></textarea>
            <button class="btn" style="background:#444;" onclick="updateHW()">æ›´æ–°é»‘æ¿å…§å®¹</button>
        </div>
        
        <div id="teacher-extra">
            <hr>
            <h4>ç®¡ç†æ­·å²åŠŸèª²</h4>
            <div id="admin-history-manage"></div>
            <h4>ä»Šæ—¥ç°½åçµ±è¨ˆ</h4>
            <div id="stats-area"></div>
            <div id="records-list"></div>
        </div>
    </div>
</div>
</body>
</html>
