<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å‰åœ‹ä¸­ 204 é›»å­è¯çµ¡ç°¿</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        :root { --muji-bg: #f2f0eb; --muji-stone: #e0dbd1; --muji-charcoal: #333333; --muji-accent: #8c8c8c; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--muji-bg); color: var(--muji-charcoal); margin: 0; padding: 15px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); }
        .school-info { font-size: 0.9em; color: var(--muji-accent); text-align: center; margin-bottom: 5px; }
        h1 { text-align: center; font-weight: 500; margin-bottom: 25px; }
        .section { border-bottom: 1px solid var(--muji-stone); padding: 25px 0; }
        .homework-list { background: #fafafa; padding: 20px; border-radius: 4px; border-left: 5px solid var(--muji-accent); min-height: 80px; font-size: 18px; white-space: pre-wrap; line-height: 1.8; }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 1.1em; }
        select, textarea, input { width: 100%; padding: 15px; border: 1px solid var(--muji-stone); border-radius: 4px; box-sizing: border-box; font-size: 16px; font-family: inherit; }
        
        /* è€å¸«è¼¸å…¥å€åŸŸ */
        #admin-panel { display: none; background: #f9f9f9; padding: 20px; border-radius: 8px; margin-top: 20px; border: 1px dashed var(--muji-accent); }
        
        /* ç°½åæ¿åŠ å¤§ */
        #signature-pad { border: 1px solid var(--muji-stone); background: #fff; width: 100%; height: 350px; touch-action: none; border-radius: 4px; }
        
        .btn { background-color: var(--muji-charcoal); color: white; border: none; padding: 15px; cursor: pointer; width: 100%; font-size: 18px; border-radius: 4px; margin-top: 10px; }
        .btn-clear { background: none; border: 1px solid var(--muji-stone); color: var(--muji-accent); padding: 8px; margin-top: 10px; width: auto; font-size: 14px; }
        .btn-admin-toggle { background-color: var(--muji-bg); color: var(--muji-accent); border: 1px solid var(--muji-stone); margin-top: 50px; font-size: 14px; }
        
        /* ç°½åå±•ç¤ºå€ */
        .sig-card { border: 1px solid var(--muji-stone); padding: 10px; margin-bottom: 10px; display: flex; flex-direction: column; align-items: center; }
        .sig-img { max-width: 100%; height: auto; background: white; border: 1px solid #eee; }
        .unsigned-list { color: #d9534f; font-weight: bold; background: #fff1f0; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <div class="school-info">å¤§å‰åœ‹ä¸­ äºŒå¹´å››ç­</div>
    <h1>é›»å­è¯çµ¡ç°¿</h1>

    <div class="section">
        <label>ğŸ“… æ—¥æœŸï¼š<span id="display-date"></span></label>
        <div id="homework-display" class="homework-list">è®€å–ä¸­...</div>
    </div>

    <div id="parent-area" class="section">
        <div class="input-group">
            <label>åº§è™Ÿå§“å</label>
            <select id="student-select"><option value="">è«‹é¸æ“‡å­¸ç”Ÿ</option></select>
        </div>
        <div class="input-group">
            <label>çµ¦é‚±è€å¸«çš„è©±</label>
            <textarea id="parent-comment" rows="2" placeholder="é¸å¡«ï¼Œæœ‰äº‹è«‹ç•™è¨€"></textarea>
        </div>
        <div class="input-group">
            <label>å®¶é•·æ‰‹å¯«ç°½å (è«‹åœ¨ä¸‹æ–¹ç©ºç™½è™•ç°½ç½²)</label>
            <canvas id="signature-pad"></canvas>
            <button class="btn-clear" onclick="signaturePad.clear()">æ¸…é™¤ç°½åä¸¦é‡ç°½</button>
        </div>
        <button class="btn" onclick="saveSignature()">ç¢ºèªå„²å­˜ä¸¦é€å‡º</button>
    </div>

    <button class="btn btn-admin-toggle" id="admin-entry-btn" onclick="adminAuth()">è€å¸«ç®¡ç†å…¥å£</button>

    <div id="admin-panel">
        <h2 style="margin-top:0">é‚±è€å¸«ç®¡ç†å°</h2>
        
        <div class="input-group">
            <label>ç·¨è¼¯ä»Šæ—¥åŠŸèª² (è¼¸å…¥å¾Œè«‹æŒ‰å„²å­˜)</label>
            <textarea id="hw-input" rows="8" placeholder="è¼¸å…¥åŠŸèª²ï¼ŒEnterå¯æ›è¡Œ"></textarea>
            <button class="btn" style="background:#5a5a5a" onclick="saveHomework()">å„²å­˜ä»Šæ—¥åŠŸèª²</button>
        </div>

        <div class="section">
            <label>ç°½åèˆ‡çµ±è¨ˆæª¢è¦–</label>
            <button class="btn" style="background:#8c8c8c" onclick="loadStats()">1. é‡æ–°æ•´ç†çµ±è¨ˆèˆ‡åå–®</button>
            <div id="stats-output" style="margin-top:15px"></div>
            
            <div id="sig-viewer" style="margin-top:20px; display:none;">
                <label>2. å®¶é•·ç°½ååœ–æª”æª¢è¦–</label>
                <div id="sig-list"></div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDDLO02aKJgvUa6Jk2GGslcWBhOtPHS4hE",
        authDomain: "homework-5072f.firebaseapp.com",
        projectId: "homework-5072f",
        storageBucket: "homework-5072f.firebasestorage.app",
        messagingSenderId: "927888465824",
        appId: "1:927888465824:web:7c6abc1c2212325900cec5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const today = new Date().toLocaleDateString('zh-TW').replace(/\//g, '-');
    document.getElementById('display-date').innerText = today;

    const students = ["ä½•ç¿ä¿¡","é™³æŸç¿°","é»ƒæ˜ç’¿","é»ƒå‰‡å–„","é»ƒæšç¿°","åŠ‰æ ¢ç¿","æ—èŠŠæƒ ","æ®µå­Ÿæ¶µ","æ´ªç…œæ™´","å¼µè‚²æ…ˆ","è¨±ä»¤éœ","å»–ä»¥æ™¨","åŠ‰æ™å¦¤"];

    // åˆå§‹åŒ–ä¸‹æ‹‰é¸å–®
    const select = document.getElementById('student-select');
    students.forEach((name, i) => {
        let opt = document.createElement('option');
        opt.value = i + 1;
        opt.textContent = `${i + 1}. ${name}`;
        select.appendChild(opt);
    });

    // ç°½åæ¿åˆå§‹åŒ–
    const canvas = document.getElementById('signature-pad');
    window.signaturePad = new SignaturePad(canvas);

    // å³æ™‚åŒæ­¥ä»Šæ—¥åŠŸèª²
    onSnapshot(doc(db, "homework", today), (snapshot) => {
        const data = snapshot.exists() ? snapshot.data().content : "ä»Šæ—¥å°šç„¡åŠŸèª²ã€‚";
        document.getElementById('homework-display').innerText = data;
        document.getElementById('hw-input').value = snapshot.exists() ? data : "";
    });

    // å®¶é•·é€å‡º
    window.saveSignature = async () => {
        const sid = select.value;
        if (!sid || signaturePad.isEmpty()) return alert("è«‹é¸æ“‡åº§è™Ÿä¸¦ç°½åï¼");
        if (!confirm(`ç¢ºèªæäº¤ ${students[sid-1]} çš„ç°½åå—ï¼Ÿ`)) return;

        try {
            await addDoc(collection(db, "responses"), {
                date: today,
                studentId: parseInt(sid),
                studentName: students[sid-1],
                comment: document.getElementById('parent-comment').value,
                signature: signaturePad.toDataURL(),
                timestamp: new Date()
            });
            alert("å„²å­˜æˆåŠŸï¼");
            location.reload();
        } catch (e) { alert("é€£ç·šéŒ¯èª¤"); }
    };

    // è€å¸«ç™»å…¥
    window.adminAuth = () => {
        const pw = prompt("ç®¡ç†å¯†ç¢¼ï¼š");
        if (pw === "0904") {
            document.getElementById('admin-panel').style.display = 'block';
            document.getElementById('admin-entry-btn').style.display = 'none';
            window.scrollTo(0, document.body.scrollHeight);
        } else { alert("å¯†ç¢¼éŒ¯èª¤"); }
    };

    // å„²å­˜åŠŸèª²åŠŸèƒ½ (ä¿®æ­£ç”¨)
    window.saveHomework = async () => {
        const content = document.getElementById('hw-input').value;
        if (!content) return alert("å…§å®¹ä¸å¯ç‚ºç©º");
        await setDoc(doc(db, "homework", today), { content, updatedAt: new Date() });
        alert("åŠŸèª²å·²å„²å­˜ä¸¦ç™¼å¸ƒï¼");
    };

    // è¼‰å…¥çµ±è¨ˆèˆ‡ç°½ååœ–æª”
    window.loadStats = async () => {
        const q = query(collection(db, "responses"), where("date", "==", today), orderBy("studentId", "asc"));
        const snap = await getDocs(q);
        let signedIds = [];
        let sigHtml = "";

        snap.forEach(d => {
            const r = d.data();
            signedIds.push(r.studentId);
            sigHtml += `
                <div class="sig-card">
                    <div style="width:100%; border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:5px;">
                        <b>åº§è™Ÿ ${r.studentId} (${r.studentName})</b><br>
                        <small>ç•™è¨€ï¼š${r.comment || 'ç„¡'}</small>
                    </div>
                    <img src="${r.signature}" class="sig-img">
                </div>`;
        });

        const unsigned = students.map((_, i) => i + 1).filter(id => !signedIds.includes(id));
        
        document.getElementById('stats-output').innerHTML = `
            <div>å·²ç°½åäººæ•¸ï¼š${signedIds.length} / 13</div>
            <div class="unsigned-list">æœªç°½åï¼š${unsigned.length === 0 ? 'å…¨æ•¸å®Œæˆ' : unsigned.join(', ')}</div>
        `;

        document.getElementById('sig-viewer').style.display = 'block';
        document.getElementById('sig-list').innerHTML = sigHtml;
    };

    // ä¿®æ­£è¡Œå‹•ç«¯ Canvas å¯¬åº¦
    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        signaturePad.clear();
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();
</script>
</body>
</html>
